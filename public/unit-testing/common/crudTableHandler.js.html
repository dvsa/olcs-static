<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for common/crudTableHandler.js</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="../prettify.css">
    <link rel="stylesheet" href="../base.css">
    <style type='text/css'>
        div.coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class="header low">
    <h1>Code coverage report for <span class="entity">common/crudTableHandler.js</span></h1>
    <h2>
        Statements: <span class="metric">41.18% <small>(14 / 34)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Branches: <span class="metric">22.22% <small>(4 / 18)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Functions: <span class="metric">28.57% <small>(2 / 7)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Lines: <span class="metric">41.18% <small>(14 / 34)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Ignored: <span class="metric"><span class="ignore-none">none</span></span> &nbsp;&nbsp;&nbsp;&nbsp;
    </h2>
    <div class="path"><a href="../index.html">All files</a> &#187; <a href="index.html">common/</a> &#187; crudTableHandler.js</div>
</div>
<div class="body">
<pre><table class="coverage">
<tr><td class="line-count">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134</td><td class="line-coverage"><span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">var OLCS = OLCS || <span class="branch-1 cbranch-no" title="branch not covered" >{};</span>
&nbsp;
/**
 * CRUD Table Handler
 */
OLCS.crudTableHandler = (function(document, $, undefined) {
&nbsp;
  "use strict";
&nbsp;
  return function init(options) {
&nbsp;
    <span class="missing-if-branch" title="if path not taken" >I</span>if (!$.isPlainObject(options)) {
<span class="cstat-no" title="statement not covered" >      options = {};</span>
    }
&nbsp;
    var crudActionSelector = options.selector ||  [
      ".table__header button:not(.js-disable-crud)",
      ".table__wrapper input[type=submit]",
      ".table__empty button"
    ].join(",");
&nbsp;
    var modalBodySelector  = ".modal__content";
    var mainBodySelector   = ".js-body";
    var modalWrapper       = ".modal__wrapper";
&nbsp;
    var F = OLCS.formHelper;
&nbsp;
    /**
     * Helper to reload the parent window behind the modal
     */
<span class="fstat-no" title="function not covered" >    function reloadParent() {</span>
<span class="cstat-no" title="statement not covered" >      OLCS.ajax({</span>
        url: window.location.href,
        success: OLCS.normaliseResponse(<span class="fstat-no" title="function not covered" >function(response) {</span>
<span class="cstat-no" title="statement not covered" >          F.render(mainBodySelector, response.body);</span>
        }),
        preloaderType: "modal"
      });
    }
&nbsp;
    $(document).on("click", crudActionSelector, <span class="fstat-no" title="function not covered" >function handleCrudClick(e) {</span>
<span class="cstat-no" title="statement not covered" >      e.preventDefault();</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >      var button = $(this);</span>
<span class="cstat-no" title="statement not covered" >      var form   = $(this).parents("form");</span>
&nbsp;
      /**
       * We manually handle rendering the modal because we need to intercept
       * any errors triggered when the user clicks a CRUD button. This isn't
       * ideal because we have to inspect the HTML (nasty) but in the absence
       * of a proper JSON payload or a better status code, it's our only
       * choice
       */
<span class="fstat-no" title="function not covered" >      function handleCrudAction(response) {</span>
        // if we find any errors or flash warnings, completely
        // re-render our main body
<span class="cstat-no" title="statement not covered" >        if (response.hasErrors || response.hasWarnings) {</span>
<span class="cstat-no" title="statement not covered" >          return F.render(mainBodySelector, response.body);</span>
        }
&nbsp;
        // otherwise clear any we might have had previously
<span class="cstat-no" title="statement not covered" >        F.clearErrors();</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >        var options = {</span>
          success: OLCS.normaliseResponse({
            /**
             * We trap redirects and handle them ourselves, because if the redirect
             * URL is the current page we want to ignore it and just hide the modal
             * instead
             */
            followRedirects: false,
            callback: handleCrudResponse
          })
        };
&nbsp;
<span class="cstat-no" title="statement not covered" >        OLCS.modalForm($.extend(response, options));</span>
      }
&nbsp;
      /**
       * We manually handle any responses or redirects
       * inside the modal; this means we have to do a bit more
       * heavy lifting than is ideal, but it gives us the flexibility
       * we need
       */
<span class="fstat-no" title="function not covered" >      function handleCrudResponse(response) {</span>
&nbsp;
        // if the original response was a redirect then be sure to respect
        // that by closing the modal
<span class="cstat-no" title="statement not covered" >        if (response.status === 302) {</span>
&nbsp;
          // We check for the data-hard-refresh attribute, as in some cases we want to fully reload the page
          // to ensure that markers etc are reloaded
<span class="cstat-no" title="statement not covered" >          if (!form.attr("data-hard-refresh") &amp;&amp; OLCS.url.isCurrent(response.location)) {</span>
<span class="cstat-no" title="statement not covered" >            return OLCS.modal.hide();</span>
          }
<span class="cstat-no" title="statement not covered" >          return OLCS.url.load(response.location);</span>
        }
&nbsp;
<span class="cstat-no" title="statement not covered" >        if (response.status === 200) {</span>
&nbsp;
          // always render; could be a clean form (if we clicked add another),
          // could be riddled with errors
<span class="cstat-no" title="statement not covered" >          F.render(modalBodySelector, response.body);</span>
&nbsp;
          // @see https://jira.i-env.net/browse/OLCS-6698
          // we used to scroll to top just in the event of errors,
          // but it's preferable to always do it instead
<span class="cstat-no" title="statement not covered" >          $(modalWrapper).scrollTop(0);</span>
        }
      }
&nbsp;
      // make sure any backend code sniffing button presses isn't disappointed
<span class="cstat-no" title="statement not covered" >      F.pressButton(form, button);</span>
&nbsp;
      // hook everything up and submit the form
<span class="cstat-no" title="statement not covered" >      OLCS.submitForm({</span>
        form: form,
        success: OLCS.normaliseResponse(handleCrudAction)
      });
    });
&nbsp;
    /**
     * Reload the parent page every time a modal is hidden. By and large this
     * works well and means our parent page is always fresh (CSRF, version numbers etc).
     * The only downside is that a user can close the modal without any interaction and
     * still trigger a spinner and a refresh which might confuse them. However, it's
     * still necessary because they've actually POSTed the original form and possibly
     * updated the version, so if they try and view another modal they'll get a version conflict
     */
    OLCS.eventEmitter.on("hide:modal", reloadParent);
  };
&nbsp;
}(document, window.jQuery));
&nbsp;</pre></td></tr>
</table></pre>

</div>
<div class="footer">
    <div class="meta">Generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Fri Mar 11 2016 10:34:48 GMT+0000 (GMT)</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
