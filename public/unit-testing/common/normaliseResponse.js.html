<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for common/normaliseResponse.js</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="../prettify.css">
    <link rel="stylesheet" href="../base.css">
    <style type='text/css'>
        div.coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class="header high">
    <h1>Code coverage report for <span class="entity">common/normaliseResponse.js</span></h1>
    <h2>
        Statements: <span class="metric">84.42% <small>(65 / 77)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Branches: <span class="metric">70.45% <small>(31 / 44)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Functions: <span class="metric">100% <small>(6 / 6)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Lines: <span class="metric">84.42% <small>(65 / 77)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Ignored: <span class="metric"><span class="ignore-none">none</span></span> &nbsp;&nbsp;&nbsp;&nbsp;
    </h2>
    <div class="path"><a href="../index.html">All files</a> &#187; <a href="index.html">common/</a> &#187; normaliseResponse.js</div>
</div>
<div class="body">
<pre><table class="coverage">
<tr><td class="line-count">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196</td><td class="line-coverage"><span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">31</span>
<span class="cline-any cline-yes">31</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">31</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">30</span>
<span class="cline-any cline-yes">30</span>
<span class="cline-any cline-yes">30</span>
<span class="cline-any cline-yes">30</span>
<span class="cline-any cline-yes">30</span>
<span class="cline-any cline-yes">30</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">8</span>
<span class="cline-any cline-yes">8</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">14</span>
<span class="cline-any cline-yes">14</span>
<span class="cline-any cline-yes">14</span>
<span class="cline-any cline-yes">14</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">14</span>
<span class="cline-any cline-yes">14</span>
<span class="cline-any cline-yes">14</span>
<span class="cline-any cline-yes">14</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">14</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">14</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8</span>
<span class="cline-any cline-yes">8</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">14</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-yes">7</span>
<span class="cline-any cline-yes">7</span>
<span class="cline-any cline-yes">7</span>
<span class="cline-any cline-yes">7</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">14</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">14</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">30</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">19</span>
<span class="cline-any cline-yes">14</span>
<span class="cline-any cline-yes">14</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">19</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">19</span>
<span class="cline-any cline-yes">18</span>
<span class="cline-any cline-yes">18</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">18</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">18</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">19</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">var OLCS = OLCS || <span class="branch-1 cbranch-no" title="branch not covered" >{};</span>
&nbsp;
OLCS.normaliseResponse = (function(window, $, undefined) {
&nbsp;
  "use strict";
&nbsp;
  // the return value is a simple function which takes
  // a callback; this callback will be invoked with the
  // normalised response...
  return function init(options) {
&nbsp;
    <span class="missing-if-branch" title="else path not taken" >E</span>if (!$.isPlainObject(options)) {
      options = {
        callback: options
      };
    }
&nbsp;
    if (typeof options.callback !== "function") {
      throw new Error("OLCS.normaliseResponse requires at least a callback argument");
    }
&nbsp;
    var callback        = options.callback;
    var titleSelector   = options.title || ".js-title";
    var bodySelector    = options.body || ".js-body,.js-body__main";
    var scriptSelector  = options.script || ".js-script";
    var rootSelector    = options.root || ".js-response";
    var followRedirects = options.followRedirects !== undefined ? <span class="branch-0 cbranch-no" title="branch not covered" >options.followRedirects </span>: true;
&nbsp;
&nbsp;
    /**
     * This method is used to paper over the cracks present in our wildly inconsistent views.
     * Ideally it wouldn't exist as every title would be rendered in a proper header view
     * and thus be placed automatically inside js-title when rendered asynchronously but that's
     * often not the case on olcs-internal. As such this method is a bit of a catch-all workhorse
     * which tries to rummage through what *should* be the body of the response and look for
     * a title-esque field
     */
    function findTitle(body) {
      var title;
      var text = "";
&nbsp;
      // first up try the sensible option; just grab the first heading which is an
      // immediate descendent of the content block
      title = $(body).find(".js-content").children("h1,h2,h3,h4,h5,h6").first();
&nbsp;
      <span class="missing-if-branch" title="else path not taken" >E</span>if (title.length === 0) {
        // okay, no luck. Internal templates often appear within a header container - try that
        title = $(body).find(".content__header");
      }
&nbsp;
      // hopefully we've got a title. If so we need to explicitly remove it from the body block
      // otherwise it'll be duplicated
      <span class="missing-if-branch" title="if path not taken" >I</span>if (title.length) {
<span class="cstat-no" title="statement not covered" >        text = title.text();</span>
<span class="cstat-no" title="statement not covered" >        $(title).remove();</span>
      }
&nbsp;
      return text;
    }
&nbsp;
    function parse(responseString) {
      var title  = "";
      var body   = "";
      var script = "";
      var response;
&nbsp;
      // this can throw if the response we get back can't be parsed (i.e. var dumped data during debug)
      try {
        title  = $(responseString).find(titleSelector);
        body   = $(responseString).find(bodySelector);
        script = $(responseString).find(scriptSelector);
      } catch (e) {
<span class="cstat-no" title="statement not covered" >        OLCS.logger.debug("Caught error parsing response", "normaliseResponse");</span>
      }
&nbsp;
      /**
       * We set up some sensible defaults here so that if we can't parse anything else
       * of use we at least turn a usable response
       */
      response = {
        status: 200,
        title: "",
        body: responseString,
        // @TODO populate actual array of errors too
        //errors: [],
        hasErrors: false,
        hasWarnings: false
      };
&nbsp;
      if (title.length) {
        OLCS.logger.debug("found response title matching " + titleSelector, "normaliseResponse");
        response.title = title.last().text();
        <span class="missing-if-branch" title="if path not taken" >I</span>if ($.trim(response.title) === "") {
<span class="cstat-no" title="statement not covered" >          OLCS.logger.debug("title selector contents is empty, falling back to searching body");</span>
<span class="cstat-no" title="statement not covered" >          response.title = findTitle(body);</span>
        }
      } else {
        OLCS.logger.debug("no matching response title for " + titleSelector + ", searching headings...", "normaliseResponse");
        response.title = findTitle(body);
      }
&nbsp;
      if (body.length) {
        var deepest = null;
        var depth = -1;
&nbsp;
        // our templates, particularly on olcs-internal, are a bit of a mess - we sometimes find multiple .js-body tags and
        // sometimes even have a .js-body within a .js-body__main (which should never be right).
        $.each(body, function(_, v) {
          var dist = $(v).parentsUntil(rootSelector).length;
          <span class="missing-if-branch" title="else path not taken" >E</span>if (dist &gt; depth) {
            depth = dist;
            deepest = $(v);
          }
        });
&nbsp;
        OLCS.logger.debug("got response body matching ." + deepest.attr("class") + " at depth " + depth, "normaliseResponse");
&nbsp;
        // js-script will often live within js-body; we want to lift it out as it'll be appended
        // afterwards
        deepest.find(scriptSelector).remove();
        response.body = deepest.html();
&nbsp;
      } else {
        OLCS.logger.debug("no matching response body for " + bodySelector, "normaliseResponse");
      }
&nbsp;
      // ensure scripts are injected too. If we want, we can
      // add an options.disableScripts or whatever to ignore them
      if (script.length) {
        OLCS.logger.debug("found inline script matching " + scriptSelector, "normaliseResponse");
        response.body += script.html();
      } else {
        OLCS.logger.debug("no matching inline script for " + scriptSelector, "normaliseResponse");
        // @TODO: if the original body contained inline script but we filtered it via js-body
        // or js-body__main, we'll have 'lost' the inline script on the page. Try and find it here
      }
&nbsp;
      return response;
    }
&nbsp;
    // ... the inner function will be invoked, we suppose, by an AJAX request or similar
    return function onResponse(response) {
&nbsp;
      if (typeof response === "string") {
        OLCS.logger.debug("converting response string to object", "normaliseResponse");
        response = parse(response);
      }
&nbsp;
      // we won't invoke the callback if the status
      // is a straightforward redirect
      <span class="missing-if-branch" title="if path not taken" >I</span>if (response.status === 302 &amp;&amp; <span class="branch-1 cbranch-no" title="branch not covered" >followRedirects)</span> {
&nbsp;
        // Fake the modal.hide functionality to avoid reloading
        // the parent
<span class="cstat-no" title="statement not covered" >        $(".modal__wrapper, .overlay").remove();</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >        if (OLCS.modal.isVisible()) {</span>
<span class="cstat-no" title="statement not covered" >          OLCS.preloader.show("modal");</span>
        }
&nbsp;
<span class="cstat-no" title="statement not covered" >        OLCS.logger.debug(</span>
          "caught 302 redirect; followRedirects=true; redirecting to " + response.location,
          "normaliseResponse"
        );
&nbsp;
<span class="cstat-no" title="statement not covered" >        return OLCS.url.load(response.location);</span>
      }
&nbsp;
      // otherwise start to inspect the response for any things of interest
      if (response.body) {
        response.hasErrors = OLCS.formHelper.containsErrors(response.body);
        response.hasWarnings = OLCS.formHelper.containsWarnings(response.body);
&nbsp;
        <span class="missing-if-branch" title="if path not taken" >I</span>if (response.hasErrors) {
<span class="cstat-no" title="statement not covered" >          OLCS.logger.debug(</span>
            "normalised response contains errors",
            "normaliseResponse"
          );
        }
&nbsp;
        <span class="missing-if-branch" title="if path not taken" >I</span>if (response.hasWarnings) {
<span class="cstat-no" title="statement not covered" >          OLCS.logger.debug(</span>
            "normalised response contains warnings",
            "normaliseResponse"
          );
        }
      }
&nbsp;
      // by the time we get here we've got a nice consistent response, whatever
      // we got back from the backend
      return callback(response);
    };
  };
&nbsp;
}(window, window.jQuery));
&nbsp;</pre></td></tr>
</table></pre>

</div>
<div class="footer">
    <div class="meta">Generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Fri Mar 11 2016 10:34:48 GMT+0000 (GMT)</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
