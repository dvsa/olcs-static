<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for common/cascadeForm.js</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="../prettify.css">
    <link rel="stylesheet" href="../base.css">
    <style type='text/css'>
        div.coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class="header high">
    <h1>Code coverage report for <span class="entity">common/cascadeForm.js</span></h1>
    <h2>
        Statements: <span class="metric">90.91% <small>(70 / 77)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Branches: <span class="metric">81.13% <small>(43 / 53)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Functions: <span class="metric">88.89% <small>(8 / 9)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Lines: <span class="metric">90.91% <small>(70 / 77)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Ignored: <span class="metric"><span class="ignore-none">none</span></span> &nbsp;&nbsp;&nbsp;&nbsp;
    </h2>
    <div class="path"><a href="../index.html">All files</a> &#187; <a href="index.html">common/</a> &#187; cascadeForm.js</div>
</div>
<div class="body">
<pre><table class="coverage">
<tr><td class="line-count">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221</td><td class="line-coverage"><span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">25</span>
<span class="cline-any cline-yes">25</span>
<span class="cline-any cline-yes">25</span>
<span class="cline-any cline-yes">25</span>
<span class="cline-any cline-yes">25</span>
<span class="cline-any cline-yes">25</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">72</span>
<span class="cline-any cline-yes">80</span>
<span class="cline-any cline-yes">80</span>
<span class="cline-any cline-yes">140</span>
<span class="cline-any cline-yes">140</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">80</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">2070</span>
<span class="cline-any cline-yes">8277</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8277</span>
<span class="cline-any cline-yes">4138</span>
<span class="cline-any cline-yes">4138</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4139</span>
<span class="cline-any cline-yes">8278</span>
<span class="cline-any cline-yes">8278</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">12416</span>
<span class="cline-any cline-yes">12416</span>
<span class="cline-any cline-yes">12416</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12416</span>
<span class="cline-any cline-yes">8276</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4140</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12416</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12415</span>
<span class="cline-any cline-yes">2069</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12415</span>
<span class="cline-any cline-yes">45</span>
<span class="cline-any cline-yes">12370</span>
<span class="cline-any cline-yes">82</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12415</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12415</span>
<span class="cline-any cline-yes">127</span>
<span class="cline-any cline-yes">127</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12415</span>
<span class="cline-any cline-yes">45</span>
<span class="cline-any cline-yes">12370</span>
<span class="cline-any cline-yes">82</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">12513</span>
<span class="cline-any cline-yes">8374</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4139</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4139</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4139</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4138</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2069</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2069</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2069</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">25</span>
<span class="cline-any cline-yes">25</span>
<span class="cline-any cline-yes">97</span>
<span class="cline-any cline-yes">97</span>
<span class="cline-any cline-yes">72</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">97</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">25</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">24</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">25</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">25</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">var OLCS = OLCS || <span class="branch-1 cbranch-no" title="branch not covered" >{};</span>
&nbsp;
/**
 * OLCS.cascadeForm
 *
 * This component should be bound to a form in which each section
 * (usually defined by a top-level fieldset) relates to the one which
 * follows it; that is the content of the following fieldset is affected
 * in some way by the input received in the current one.
 */
&nbsp;
OLCS.cascadeForm = (function(document, $, undefined) {
&nbsp;
  "use strict";
&nbsp;
  return function init(options) {
    var selector = options.form || <span class="branch-1 cbranch-no" title="branch not covered" >"form";</span>
    var formSelector = selector;
    var previousFieldset;
    var cascade = options.cascade !== undefined ? <span class="branch-0 cbranch-no" title="branch not covered" >options.cascade </span>: true;
    var onSubmit = options.submit;
    var errorWrapper = options.errorWrapper || ".validation-wrapper";
&nbsp;
    /**
     * by using a closure we ensure this function is safe
     * to bind inside loops etc
     */
    function clearFieldset(target) {
      /**
       * the actual event handler simply finds all inputs in the
       * target fieldset and clears them out
       *
       * @TODO only checkboxes and radios are supported at the moment, easy to
       * change though
       */
      return function clear() {
        var elems = $(target).find(":input");
        $.each(elems, function(i, elem) {
          elem = $(elem);
          <span class="missing-if-branch" title="if path not taken" >I</span>if (elem.is(":checked")) {
<span class="cstat-no" title="statement not covered" >            elem.removeAttr("checked");</span>
          }
        });
        // ensure the change notification cascades down the line
        $(target).trigger("change");
      };
    }
&nbsp;
    /**
     * Iterate over the form, checking the relevant rulesets.
     *
     * We generally expect each ruleset to apply to a fieldset
     * but allow for exceptions. Once we've found a fieldset or
     * element, we invoke its predicate which can either be a
     * bool or function
     */
    function checkForm() {
      for (var fieldset in options.rulesets) {
        var ruleset = options.rulesets[fieldset];
&nbsp;
        // if the rule value is a string or a function then assume
        // it applies to the fieldset as a whole
        if (!$.isPlainObject(ruleset)) {
          triggerRule(fieldset, "*", ruleset);
          continue;
        }
&nbsp;
        // if the value was an object, iterate its key/vals and trigger
        // a rule on each of them, bound to the outer fieldset
        for (var selector in ruleset) {
          var rule = ruleset[selector];
          triggerRule(fieldset, selector, rule);
        }
      }
    }
&nbsp;
    /**
     * invoke a rule against an element or fieldset. The
     * end result will be the showing or hiding of the
     * relevant element
     *
     * Usually traverses up the DOM tree to see if the matched container
     * itself sits within an error message and treats that as the parent
     * if so; although currently there are exceptions to this
     */
    function triggerRule(group, selector, rule) {
      var show;
      var elem;
      var action = "none";
&nbsp;
      if ($.isFunction(rule)) {
        show = rule.call($(formSelector));
      } else {
        show = rule;
      }
&nbsp;
      elem = findContainer(group, selector);
&nbsp;
      // are we currently sat inside a validation error wrapper? If
      // so that becomes the top-level element
      // note that key=val selectors are an exception to this rule
      // and as such we never check their containers
      if (selector.search("=") === -1 &amp;&amp; elem.parents(errorWrapper).length) {
        elem = elem.parents(errorWrapper);
      }
&nbsp;
      if (show &amp;&amp; elem.is(":hidden")) {
        action = "show";
      } else if (!show &amp;&amp; elem.is(":visible")) {
        action = "hide";
      }
      OLCS.logger.verbose(
        group + " &gt; " + selector +
          ", should show? (" + show + "), is visible? (" +
          elem.is(":visible") + "), action: (" +
          action + ")",
        "cascadeForm"
      );
&nbsp;
      if (action !== "none") {
        elem[action]();
        OLCS.eventEmitter.emit(action + ":" + group + ":" + selector);
      }
      
      if (action === "show") {
        elem.attr("aria-hidden", "false");
      } else if (action === "hide") {
        elem.attr("aria-hidden", "true");
      }
    }
&nbsp;
    /**
     * find a container or element based on a group (i.e. a fieldset)
     * and selector. Takes a special asterisk(*) argument to represent
     * the group itself rather than a child
     */
    function findContainer(group, selector) {
      if (selector === "*") {
        return OLCS.formHelper(group);
      }
&nbsp;
      var parts;
&nbsp;
      // shorthands for ID and class selectors
      <span class="missing-if-branch" title="if path not taken" >I</span>if (selector.substring(0, 1) === "#" || selector.substring(0, 1) === ".") {
<span class="cstat-no" title="statement not covered" >        selector = "selector:" + selector;</span>
      }
&nbsp;
      if (selector.search(":") !== -1) {
&nbsp;
        parts = selector.split(":");
&nbsp;
        switch (parts[0]) {
<span class="branch-0 cbranch-no" title="branch not covered" >          case "label":</span>
            // @NOTE: we make some assumptions about the markup surrounding labels
            // feel free to update as and when
<span class="cstat-no" title="statement not covered" >            return $(formSelector).find("label[for=" + parts[1] + "]").parents(".field");</span>
<span class="branch-1 cbranch-no" title="branch not covered" >          case "selector":</span>
<span class="cstat-no" title="statement not covered" >            return $(formSelector).find(parts[1]);</span>
<span class="branch-2 cbranch-no" title="branch not covered" >          case "date":</span>
<span class="cstat-no" title="statement not covered" >            return $(formSelector).find("[name*=" + parts[1] + "]").parents(".field");</span>
<span class="branch-3 cbranch-no" title="branch not covered" >          case "parent":</span>
<span class="cstat-no" title="statement not covered" >            return $(formSelector).find(parts[1]).parent();</span>
          default:
            throw new Error("Unsupported left-hand selector: " + parts[0]);
        }
      }
&nbsp;
      if (selector.search("=") !== -1) {
&nbsp;
        // assume a name=value pair specifies a radio button with a given value
        parts = selector.split("=");
&nbsp;
        // @TODO `group` isn't always right here; it can be an arbitrary selector
        // not just a data-group=xxx name. This needs fixing at some point
        return OLCS.formHelper.findInput(group, parts[0])
        .filter("[value=" + parts[1] + "]")
        // radios are always wrapped inside a label
        .parents("label:last");
&nbsp;
      }
&nbsp;
      // otherwise assume a straight input name which we assume is inside a field container
      return OLCS.formHelper(group, selector).parents(".field");
&nbsp;
    }
&nbsp;
    /*
     * first things first, find the top-level fieldsets and bind some
     * handlers such that when they change, the event cascades to
     * all subsequent fieldsets emptying them out
     */
    <span class="missing-if-branch" title="else path not taken" >E</span>if (cascade) {
      for (var fieldset in options.rulesets) {
        var current = findContainer(fieldset, "*");
        if (previousFieldset) {
          $(previousFieldset).on(
            "change",
            clearFieldset(current)
          );
        }
        previousFieldset = current;
      }
    }
&nbsp;
    if (onSubmit) {
      // we'd like to use bind, but IE8 won't let us
      $(document).on("submit", formSelector, <span class="fstat-no" title="function not covered" >function(e) {</span>
<span class="cstat-no" title="statement not covered" >        onSubmit.call($(formSelector), e);</span>
      });
    }
&nbsp;
    $(document).on("change", formSelector, checkForm);
&nbsp;
    // hmm. This will outlive the component, which means when the component re-binds (if it's in a modal and uses jquery.onReady)
    // then this will stack multiple listeners
    OLCS.eventEmitter.on("render", checkForm);
  };
&nbsp;
}(document, window.jQuery));
&nbsp;</pre></td></tr>
</table></pre>

</div>
<div class="footer">
    <div class="meta">Generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Fri Mar 11 2016 10:34:48 GMT+0000 (GMT)</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
